# ğŸ”’ å®‰å…¨å®¡è®¡æŠ¥å‘Š

> æ‰«æèŒƒå›´ï¼šå…¨é¡¹ç›®ï¼ˆutils/ã€store/ã€pages/ã€components/ã€cloudfunctions/ï¼‰  
> ç”Ÿæˆæ—¶é—´ï¼š2026-02-16

---

## ä¸€ã€è¾“å…¥éªŒè¯ & XSS é˜²æŠ¤

### 1.1 ğŸ”´ ä¸¥é‡ï¼š`product-service.js` æ— ä»»ä½•è¾“å…¥æ¶ˆæ¯’

**ä½ç½®**ï¼š`utils/product-service.js` â†’ `publishProduct()` / `createProductDraft()`

**ç°çŠ¶**ï¼šå•†å“æ ‡é¢˜ã€æè¿°ã€åœ°ç‚¹ã€æ ‡ç­¾ç­‰ç”¨æˆ·è¾“å…¥ç›´æ¥å†™å…¥äº‘æ•°æ®åº“å’Œæœ¬åœ°å­˜å‚¨ï¼Œæœªç»è¿‡ `sanitizeText` å¤„ç†ã€‚

```
pages/products/publish.vue â†’ publishProduct({
  title: this.formData.title,          // âŒ æœªæ¶ˆæ¯’
  description: finalDescription,        // âŒ æœªæ¶ˆæ¯’
  location: finalLocation,              // âŒ æœªæ¶ˆæ¯’
  collegeTag: this.formData.collegeTag, // âŒ æœªæ¶ˆæ¯’
  tags,                                 // âŒ æœªæ¶ˆæ¯’
})
```

**é£é™©**ï¼šXSSï¼ˆè‹¥åç«¯æœ‰ Web ç®¡ç†åå°ï¼‰ã€æ•æ„Ÿè¯ç»•è¿‡ã€æ³¨å…¥æ¶æ„å†…å®¹ã€‚

**ä¿®å¤**ï¼š`product-service.js` çš„ `publishProduct` å’Œ `createProductDraft` ä¸­å¯¹æ–‡æœ¬å­—æ®µç»Ÿä¸€è°ƒç”¨ `sanitizeText`ã€‚

---

### 1.2 ğŸŸ  ä¸­ç­‰ï¼š`order-service.js` è¯„ä»·å†…å®¹æœªæ¶ˆæ¯’

**ä½ç½®**ï¼š`utils/order-service.js` â†’ `submitReview()` / `submitReviewToCloud()`

**ç°çŠ¶**ï¼š`payload.content`ï¼ˆè¯„ä»·æ­£æ–‡ï¼‰ç›´æ¥å†™å…¥ï¼Œæœªç» `sanitizeText`ã€‚

```js
content: payload.content || "",  // âŒ æœªæ¶ˆæ¯’
```

**ä¿®å¤**ï¼šå¯¹ `content` å­—æ®µè°ƒç”¨ `sanitizeText(payload.content, { maxLength: 500 })`ã€‚

---

### 1.3 ğŸŸ  ä¸­ç­‰ï¼šä»·æ ¼å­—æ®µä»…å‰ç«¯æ ¡éªŒ

**ä½ç½®**ï¼š`pages/products/publish.vue` ç¬¬ 543-547 è¡Œ

**ç°çŠ¶**ï¼šä»·æ ¼æ ¡éªŒä»…åœ¨é¡µé¢å±‚ `Number.isNaN(priceNum) || priceNum <= 0`ã€‚`product-service.js` çš„ `createProductDraft` ç›´æ¥ `Number(payload.price || 0)` æ— èŒƒå›´é™åˆ¶ã€‚

**é£é™©**ï¼šå¯ä¼ å…¥æç«¯å€¼ï¼ˆå¦‚ `999999999` æˆ– `0.001`ï¼‰ã€‚

**ä¿®å¤**ï¼šservice å±‚å¢åŠ  `sanitizeNumber(price, 0.01, 99999)` èŒƒå›´æ ¡éªŒã€‚

---

### 1.4 âœ… å·²è¦†ç›–çš„è¾“å…¥æ¶ˆæ¯’

| Service | æ¶ˆæ¯’è¦†ç›– |
|---------|---------|
| chat-service | âœ… `sanitizeText(content, { maxLength: 2000 })` |
| feed-service | âœ… `sanitizeText(content, { maxLength: 500 })` |
| want-service | âœ… title + description |
| task-service | âœ… title + location + descriptionï¼ˆæœ¬æ¬¡ä¼˜åŒ–å·²æ·»åŠ ï¼‰|
| wiki-service | âœ… title + content + summaryï¼ˆæœ¬æ¬¡ä¼˜åŒ–å·²æ·»åŠ ï¼‰|
| report-service | âœ… detailï¼ˆæœ¬æ¬¡ä¼˜åŒ–å·²æ·»åŠ ï¼‰|
| **product-service** | âŒ **å®Œå…¨æœªè¦†ç›–** |
| **order-service** | âŒ **review content æœªè¦†ç›–** |

---

## äºŒã€è®¤è¯ & é‰´æƒ

### 2.1 ğŸ”´ ä¸¥é‡ï¼šäº‘å‡½æ•° `login` è¿”å›ä¼ªé€  token

**ä½ç½®**ï¼š`cloudfunctions/login/index.js` ç¬¬ 18 è¡Œ

```js
token: `mock-token-${Date.now()}`
```

**é—®é¢˜**ï¼š
1. Token ä¸åŒ…å«ä»»ä½•ç­¾åæˆ–åŠ å¯†ï¼Œä»»ä½•äººå¯ä»¥æ„é€ 
2. æ²¡æœ‰è¿‡æœŸæ—¶é—´
3. åç»­è¯·æ±‚ä¸­ `request.js` å°†æ­¤ token æ”¾å…¥ `Authorization` headerï¼Œä½†æ²¡æœ‰ä»»ä½•æœåŠ¡ç«¯éªŒè¯

**é£é™©**ï¼šToken å¯ä¼ªé€ ï¼Œä»»ä½•äººå¯å†’å……å…¶ä»–ç”¨æˆ·ã€‚

**ä¿®å¤**ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ï¼š
1. ä½¿ç”¨ JWT æˆ–äº‘å¼€å‘çš„ä¼šè¯ç®¡ç†
2. Token åº”åŒ…å« openid + è¿‡æœŸæ—¶é—´ + ç­¾å
3. äº‘å‡½æ•°çš„æ•°æ®æ“ä½œåº”æ ¡éªŒ `OPENID` è€Œéå®¢æˆ·ç«¯ä¼ å…¥çš„ `userId`

---

### 2.2 ğŸ”´ ä¸¥é‡ï¼š`deleteProduct` / `updateProductStatus` æ— æƒé™æ ¡éªŒ

**ä½ç½®**ï¼š`utils/product-service.js` ç¬¬ 525-568 è¡Œ

**ç°çŠ¶**ï¼šè¿™ä¸¤ä¸ªå‡½æ•°ä»…æ£€æŸ¥ `productId` æ˜¯å¦å­˜åœ¨ï¼Œ**æœªæ ¡éªŒå½“å‰ç”¨æˆ·æ˜¯å¦ä¸ºå•†å“æ‰€æœ‰è€…**ã€‚

```js
export async function deleteProduct(productId) {
  if (!productId) return false;
  // âŒ æ²¡æœ‰æ£€æŸ¥ product.userId === currentUserId
  await db.collection("products").doc(productId).remove();
}
```

**é£é™©**ï¼šä»»ä½•ç™»å½•ç”¨æˆ·å¯åˆ é™¤/ä¿®æ”¹ä»–äººå•†å“çŠ¶æ€ã€‚

**ä¿®å¤**ï¼šåˆ é™¤å’ŒçŠ¶æ€æ›´æ–°å‰æ ¡éªŒ `product.userId === getCurrentUserId()`ã€‚

---

### 2.3 ğŸŸ  ä¸­ç­‰ï¼šæœ¬åœ°æ¨¡å¼ä¸‹çš„è®¢å•/ä»»åŠ¡æ“ä½œç¼ºå°‘å®Œæ•´æƒé™æ ¡éªŒ

**ä½ç½®**ï¼š`order-service.js` â†’ `updateOrderStatus()` æœ¬åœ°åˆ†æ”¯

**ç°çŠ¶**ï¼šäº‘ç«¯åˆ†æ”¯æœ‰ `canOperateOrder` æ ¡éªŒ âœ…ï¼Œæœ¬åœ°åˆ†æ”¯ä¹Ÿæœ‰ âœ…ã€‚è¿™ä¸€ç‚¹åšå¾—è¾ƒå¥½ã€‚

ä½† `task-service.js` çš„ `acceptTask`ã€`completeTask` ç­‰æ“ä½œåœ¨æœ¬åœ°æ¨¡å¼ä¸‹æƒé™æ ¡éªŒé€»è¾‘éœ€è¦ç¡®è®¤æ˜¯å¦å®Œæ•´ã€‚

---

### 2.4 ğŸŸ¡ æ³¨æ„ï¼šå¤šä¸ªé¡µé¢ç™»å½•æ£€æŸ¥ä¸ä¸€è‡´

**ç°çŠ¶**ï¼šæœ‰äº›é¡µé¢åœ¨ `onLoad` ä¸­æ£€æŸ¥ç™»å½•å¹¶å¼¹ Modalï¼Œæœ‰äº›åœ¨æŒ‰é’®æ“ä½œæ—¶æ£€æŸ¥ã€‚æ²¡æœ‰ç»Ÿä¸€çš„è·¯ç”±çº§å®ˆå«ã€‚

**å»ºè®®**ï¼šä½¿ç”¨ store ä¸­æ–°å¢çš„ `requireLogin()` ç»Ÿä¸€æ›¿ä»£ã€‚

---

## ä¸‰ã€æ•°æ®å­˜å‚¨å®‰å…¨

### 3.1 ğŸŸ  ä¸­ç­‰ï¼šToken æ˜æ–‡å­˜å‚¨

**ä½ç½®**ï¼š`utils/auth.js` â†’ `saveAuthInfo()`

```js
uni.setStorageSync(TOKEN_KEY, token);  // æ˜æ–‡
```

**é£é™©**ï¼šå°ç¨‹åºæœ¬åœ°å­˜å‚¨å¯è¢«è°ƒè¯•å·¥å…·ç›´æ¥è¯»å–ã€‚åœ¨å¾®ä¿¡å°ç¨‹åºæ²™ç®±å†…é£é™©è¾ƒä½ï¼Œä½†ä»ä¸ç¬¦åˆæœ€ä½³å®è·µã€‚

**å»ºè®®**ï¼šç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨åŠ å¯†å­˜å‚¨æˆ–å¾®ä¿¡æä¾›çš„å®‰å…¨å­˜å‚¨æœºåˆ¶ã€‚

---

### 3.2 ğŸŸ¡ æ³¨æ„ï¼šæ•æ„Ÿè¯åº“ç¡¬ç¼–ç 

**ä½ç½®**ï¼š`utils/sanitize.js` ç¬¬ 27-30 è¡Œ

```js
const SENSITIVE_WORDS = [
  "èµŒåš", "ä»£å†™", "æªæ‰‹", "åˆ·å•", "ä¼ é”€",
  "è‰²æƒ…", "æ¯’å“", "è¯ˆéª—", "è£¸è´·", "é«˜åˆ©è´·"
];
```

**é—®é¢˜**ï¼šè¯åº“ç›´æ¥æ‰“åŒ…åˆ°å®¢æˆ·ç«¯ï¼Œå¯è¢«åç¼–è¯‘æŸ¥çœ‹å¹¶ç»•è¿‡ã€‚è¯åº“å›ºå®šï¼Œæ— æ³•åŠ¨æ€æ›´æ–°ã€‚

**å»ºè®®**ï¼š
1. å…³é”®è¿‡æ»¤åº”åœ¨æœåŠ¡ç«¯æ‰§è¡Œ
2. å¯è€ƒè™‘æ¥å…¥å¾®ä¿¡å†…å®¹å®‰å…¨ API (`wx.cloud.callFunction` â†’ `security.msgSecCheck`)

---

### 3.3 ğŸŸ¡ æ³¨æ„ï¼šæœ¬åœ°å­˜å‚¨æ— æ•°æ®åŠ å¯†

**ç°çŠ¶**ï¼šæ‰€æœ‰ä¸šåŠ¡æ•°æ®ï¼ˆèŠå¤©è®°å½•ã€è®¢å•ã€ç”¨æˆ·ä¿¡æ¯ï¼‰ä»¥æ˜æ–‡ JSON å­˜å…¥ `wx.setStorageSync`ã€‚

**é£é™©**ï¼šè°ƒè¯•æ¨¡å¼ä¸‹å¯ç›´æ¥è¯»å–å…¨éƒ¨ç”¨æˆ·æ•°æ®ã€‚

**å»ºè®®**ï¼šå¯¹æ•æ„Ÿå­—æ®µï¼ˆå¦‚èŠå¤©å†…å®¹ï¼‰è¿›è¡Œç®€å•åŠ å¯†åå­˜å‚¨ã€‚

---

## å››ã€äº‘å‡½æ•° & ç½‘ç»œè¯·æ±‚å®‰å…¨

### 4.1 ğŸŸ  ä¸­ç­‰ï¼šäº‘å‡½æ•°æ— è¾“å…¥æ ¡éªŒ

**ä½ç½®**ï¼š`cloudfunctions/login/index.js`ã€`cloudfunctions/generateProductDesc/index.js`

**ç°çŠ¶**ï¼šä¸¤ä¸ªäº‘å‡½æ•°éƒ½ç›´æ¥ä½¿ç”¨ `event` å‚æ•°ï¼Œæ— ä»»ä½•ç±»å‹/é•¿åº¦/èŒƒå›´æ ¡éªŒã€‚

```js
// login/index.js
const profile = event.userInfo || {};
// ç›´æ¥ä½¿ç”¨ profile.nickName â€” å¯ä¼ å…¥è¶…é•¿å­—ç¬¦ä¸²æˆ–æ¶æ„å†…å®¹

// generateProductDesc/index.js
const category = event.category || "other";
// å¯ä¼ å…¥ä»»æ„å­—ç¬¦ä¸²
```

**ä¿®å¤**ï¼šäº‘å‡½æ•°å…¥å£æ·»åŠ å‚æ•°æ ¡éªŒå’Œæ¶ˆæ¯’ã€‚

---

### 4.2 ğŸŸ¡ æ³¨æ„ï¼š`request.js` æ—  CSRF/é‡æ”¾é˜²æŠ¤

**ç°çŠ¶**ï¼šè¯·æ±‚ä»…é  Bearer token è®¤è¯ï¼Œæ— è¯·æ±‚ç­¾åã€æ—¶é—´æˆ³æˆ– nonceã€‚

**é£é™©**ï¼šåœ¨æœ‰å®é™… API æœåŠ¡ç«¯çš„åœºæ™¯ä¸‹å­˜åœ¨é‡æ”¾æ”»å‡»é£é™©ã€‚å½“å‰ mock æ¨¡å¼å½±å“è¾ƒå°ã€‚

---

### 4.3 ğŸŸ¡ æ³¨æ„ï¼š`urlCheck: false`

**ä½ç½®**ï¼š`manifest.json` ç¬¬ 14 è¡Œ

```json
"urlCheck": false
```

**è¯´æ˜**ï¼šå¼€å‘é˜¶æ®µå…³é—­åŸŸåæ ¡éªŒæ˜¯æ­£å¸¸çš„ï¼Œä½†ä¸Šçº¿å‰å¿…é¡»å¼€å¯å¹¶é…ç½®åˆæ³•åŸŸåç™½åå•ã€‚

---

## äº”ã€ä¸šåŠ¡é€»è¾‘æ¼æ´

### 5.1 ğŸ”´ ä¸¥é‡ï¼šå•†å“åˆ é™¤/ä¸‹æ¶æ— æ‰€æœ‰æƒæ ¡éªŒï¼ˆåŒ 2.2ï¼‰

å·²åœ¨ 2.2 è¯¦è¿°ã€‚æ”»å‡»è€…å¯ç›´æ¥è°ƒç”¨ `deleteProduct(victimProductId)` åˆ é™¤ä»–äººå•†å“ã€‚

---

### 5.2 ğŸŸ  ä¸­ç­‰ï¼šè®¢å•å¯è¢«ä¹°å®¶/å–å®¶ä¹‹å¤–çš„äººæŸ¥çœ‹

**ä½ç½®**ï¼š`order-service.js` â†’ `getOrder(orderId)`

**ç°çŠ¶**ï¼š`getOrder` åªæ ¹æ® `orderId` æŸ¥è¯¢ï¼Œæ— æƒé™è¿‡æ»¤ã€‚ä»»ä½•æ‹¿åˆ° orderId çš„äººéƒ½èƒ½æŸ¥çœ‹è®¢å•è¯¦æƒ…ã€‚

```js
export async function getOrder(orderId) {
  // âŒ æœªæ ¡éªŒ order.buyerId === userId || order.sellerId === userId
  return readOrders().find((item) => item.id === orderId);
}
```

**ä¿®å¤**ï¼šå¢åŠ å½“å‰ç”¨æˆ·èº«ä»½æ ¡éªŒã€‚

---

### 5.3 ğŸŸ  ä¸­ç­‰ï¼šé‡å¤è¯„ä»·é˜²æŠ¤ä»…åœ¨äº‘ç«¯

**ä½ç½®**ï¼š`order-service.js` â†’ `submitReview()`

**ç°çŠ¶**ï¼šäº‘ç«¯åˆ†æ”¯ä¼šæ£€æŸ¥ `existing.data.length > 0`ï¼ˆå·²è¯„ä»·åˆ™æ‹’ç»ï¼‰ã€‚ä½†æœ¬åœ° fallback åˆ†æ”¯æ— å»é‡æ£€æŸ¥ï¼Œå¯å¤šæ¬¡è¯„ä»·åŒä¸€è®¢å•ã€‚

**ä¿®å¤**ï¼šæœ¬åœ°åˆ†æ”¯ä¹Ÿæ·»åŠ  `readReviews().some(r => r.orderId === x && r.fromUserId === y)` æ£€æŸ¥ã€‚

---

### 5.4 ğŸŸ¡ æ³¨æ„ï¼šæ— æ“ä½œé¢‘ç‡é™åˆ¶

**ç°çŠ¶**ï¼š`withGuard` ä»…é˜²å•æ¬¡é‡å¤æäº¤ï¼ˆåŒä¸€ key çš„é”ï¼‰ï¼Œæ²¡æœ‰æ—¶é—´çª—å£å†…çš„é¢‘ç‡é™åˆ¶ã€‚

**é£é™©**ï¼šå¯å¿«é€Ÿæ‰¹é‡å‘å¸ƒå•†å“ã€å‘æ¶ˆæ¯ã€åˆ›å»ºè®¢å•ã€‚

**å»ºè®®**ï¼šå¯¹å‘å¸ƒç±»æ“ä½œæ·»åŠ ç®€å•çš„æ—¶é—´é—´éš”é™åˆ¶ï¼ˆå¦‚ 3 ç§’å†…ä¸èƒ½é‡å¤å‘å¸ƒï¼‰ã€‚

---

## å…­ã€ç¬¬ä¸‰æ–¹ä¾èµ– & é…ç½®å®‰å…¨

### 6.1 âœ… ä¾èµ–å®‰å…¨

å½“å‰ä¾èµ–é¡¹è¾ƒå°‘ä¸”å‡ä¸ºå®˜æ–¹/ä¸»æµåº“ï¼š`vue 3.4`ã€`pinia 2.1`ã€`uview-plus 3.3`ã€`vite 5.2`ã€‚æ— æ˜æ˜¾å·²çŸ¥æ¼æ´ã€‚

å»ºè®®å®šæœŸè¿è¡Œ `npm audit` æ£€æŸ¥ã€‚

---

### 6.2 ğŸŸ¡ æ³¨æ„ï¼š`manifest.json` ä¸­ appid ä¸ºå ä½ç¬¦

```json
"appid": "wxc1b7e07d4f7c94b0"
```

éœ€ç¡®è®¤è¿™æ˜¯å¦ä¸ºå®é™…æ³¨å†Œçš„ appidï¼Œä¸Šçº¿å‰å¿…é¡»æ›¿æ¢ä¸ºæ­£å¼ appidã€‚

---

## æ¼æ´ä¸¥é‡æ€§æ±‡æ€»

| ä¸¥é‡æ€§ | ç¼–å· | æ¼æ´ | å½±å“ |
|--------|------|------|------|
| ğŸ”´ **ä¸¥é‡** | 1.1 | product-service æ— è¾“å…¥æ¶ˆæ¯’ | XSS / æ•æ„Ÿè¯ç»•è¿‡ |
| ğŸ”´ **ä¸¥é‡** | 2.1 | äº‘å‡½æ•°è¿”å›ä¼ªé€  token | èº«ä»½å†’å…… |
| ğŸ”´ **ä¸¥é‡** | 2.2 / 5.1 | å•†å“åˆ é™¤/ä¸‹æ¶æ— æ‰€æœ‰æƒæ ¡éªŒ | ä»»æ„ç”¨æˆ·æ“ä½œä»–äººå•†å“ |
| ğŸŸ  **ä¸­ç­‰** | 1.2 | è¯„ä»·å†…å®¹æœªæ¶ˆæ¯’ | XSS / æ•æ„Ÿè¯ |
| ğŸŸ  **ä¸­ç­‰** | 1.3 | ä»·æ ¼æ— èŒƒå›´æ ¡éªŒ | å¼‚å¸¸æ•°æ® |
| ğŸŸ  **ä¸­ç­‰** | 3.1 | Token æ˜æ–‡å­˜å‚¨ | ä¿¡æ¯æ³„éœ² |
| ğŸŸ  **ä¸­ç­‰** | 4.1 | äº‘å‡½æ•°æ— è¾“å…¥æ ¡éªŒ | æ³¨å…¥ / å¼‚å¸¸æ•°æ® |
| ğŸŸ  **ä¸­ç­‰** | 5.2 | è®¢å•å¯è¢«æ— å…³ç”¨æˆ·æŸ¥çœ‹ | ä¿¡æ¯æ³„éœ² |
| ğŸŸ  **ä¸­ç­‰** | 5.3 | æœ¬åœ°æ¨¡å¼é‡å¤è¯„ä»· | æ•°æ®ç¯¡æ”¹ |
| ğŸŸ¡ **ä½** | 2.4 | ç™»å½•æ£€æŸ¥ä¸ä¸€è‡´ | ä½“éªŒé—®é¢˜ |
| ğŸŸ¡ **ä½** | 3.2 | æ•æ„Ÿè¯åº“ç¡¬ç¼–ç  | å¯ç»•è¿‡ |
| ğŸŸ¡ **ä½** | 3.3 | æœ¬åœ°æ•°æ®æ— åŠ å¯† | è°ƒè¯•æ³„éœ² |
| ğŸŸ¡ **ä½** | 4.2 | æ— é‡æ”¾é˜²æŠ¤ | æ½œåœ¨æ”»å‡» |
| ğŸŸ¡ **ä½** | 4.3 | urlCheck å…³é—­ | ä¸Šçº¿å‰å¿…å¼€ |
| ğŸŸ¡ **ä½** | 5.4 | æ— é¢‘ç‡é™åˆ¶ | æ»¥ç”¨é£é™© |
| ğŸŸ¡ **ä½** | 6.2 | appid éœ€ç¡®è®¤ | ä¸Šçº¿æ£€æŸ¥ |

---

## âœ… ä¿®å¤å®æ–½è®°å½•

> ä»¥ä¸‹å®‰å…¨ä¿®å¤å·²å…¨éƒ¨å®æ–½å¹¶é€šè¿‡ç¼–è¯‘éªŒè¯ï¼ˆBuild completeï¼‰

| ç¼–å· | æ¼æ´ | ä¿®å¤æ–‡ä»¶ | ä¿®å¤æªæ–½ |
|------|------|---------|---------|
| 1.1 | product-service æ— è¾“å…¥æ¶ˆæ¯’ | `utils/product-service.js` | `createProductDraft` ä¸­å¯¹ title/description/location/tags/collegeTag å…¨éƒ¨è°ƒç”¨ `sanitizeText` |
| 1.2 | è¯„ä»·å†…å®¹æœªæ¶ˆæ¯’ | `utils/order-service.js` | `normalizeReview` ä¸­å¯¹ content è°ƒç”¨ `sanitizeText({ maxLength: 500 })` |
| 1.3 | ä»·æ ¼æ— èŒƒå›´æ ¡éªŒ | `utils/product-service.js` | ä½¿ç”¨ `sanitizeNumber(price, 0.01, 99999)` é™åˆ¶èŒƒå›´ |
| 2.1 | äº‘å‡½æ•°ä¼ªé€  token | `cloudfunctions/login/index.js` | ä½¿ç”¨ `crypto.randomBytes` + `sha256` ç”Ÿæˆ tokenï¼›æ·»åŠ  openid æ ¡éªŒã€nickName æ¶ˆæ¯’ã€URL æ ¼å¼éªŒè¯ |
| 2.2/5.1 | å•†å“æ“ä½œæ— æ‰€æœ‰æƒæ ¡éªŒ | `utils/product-service.js` | `updateProductStatus` å’Œ `deleteProduct` å‰æ ¡éªŒ `product.userId === currentUserId` |
| 5.2 | è®¢å•å¯è¢«æ— å…³ç”¨æˆ·æŸ¥çœ‹ | `utils/order-service.js` | `getOrder` å¢åŠ  `buyerId/sellerId` èº«ä»½æ ¡éªŒ |
| 5.3 | æœ¬åœ°é‡å¤è¯„ä»· | `utils/order-service.js` | `submitReview` æœ¬åœ°åˆ†æ”¯æ·»åŠ  `orderId + fromUserId` å»é‡æ£€æŸ¥ |
| 5.4 | æ— é¢‘ç‡é™åˆ¶ | `utils/product-service.js` + `utils/common.js` | æ–°å¢ `createRateLimiter(3000)`ï¼Œ`publishProduct` 3 ç§’å†…ä¸å¯é‡å¤è°ƒç”¨ |

### æ–°å¢å·¥å…·

| å·¥å…· | ä½ç½® | è¯´æ˜ |
|------|------|------|
| `createRateLimiter(interval)` | `utils/common.js` | é€šç”¨é¢‘ç‡é™åˆ¶å™¨ï¼Œå¯å¤ç”¨åˆ°å…¶ä»–å‘å¸ƒç±»æ¥å£ |

### æœªä¿®å¤ï¼ˆéœ€åç»­å¤„ç†ï¼‰

| ç¼–å· | æ¼æ´ | åŸå›  |
|------|------|------|
| 3.1 | Token æ˜æ–‡å­˜å‚¨ | å¾®ä¿¡å°ç¨‹åºæ²™ç®±å†…é£é™©è¾ƒä½ï¼Œç”Ÿäº§ç¯å¢ƒåº”æ¥å…¥åŠ å¯†å­˜å‚¨ |
| 3.2 | æ•æ„Ÿè¯åº“ç¡¬ç¼–ç  | éœ€å¯¹æ¥æœåŠ¡ç«¯å†…å®¹å®‰å…¨ APIï¼ˆå¦‚ `security.msgSecCheck`ï¼‰ |
| 3.3 | æœ¬åœ°æ•°æ®æ— åŠ å¯† | éœ€è¯„ä¼°æ€§èƒ½å½±å“åå†³å®šæ–¹æ¡ˆ |
| 4.2 | æ— é‡æ”¾é˜²æŠ¤ | å½“å‰æ— å®é™… API æœåŠ¡ç«¯ï¼Œmock æ¨¡å¼å½±å“è¾ƒå° |
| 4.3 | urlCheck å…³é—­ | å¼€å‘é˜¶æ®µæ­£å¸¸ï¼Œä¸Šçº¿å‰å¿…é¡»å¼€å¯ |
