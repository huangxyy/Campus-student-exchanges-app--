# P2 提审前检查清单（稳定性 / 安全 / 配置）

> 目标：确保稳定性、错误率、回退率、安全配置满足上线要求。

---

## 1. 构建与基础可用性

- [ ] `npm run build:mp-weixin` 成功
- [ ] 微信开发者工具导入 `dist/build/mp-weixin` 无阻塞报错
- [ ] 商品/任务/聊天主路径可完整走通

---

## 2. 云调用治理（统一包装）

- [ ] 关键服务已接入统一包装：`product-service` / `task-service` / `chat-service`
- [ ] 云调用具备超时控制（默认 8s）
- [ ] 关键查询/写入具备有限重试（按场景配置）
- [ ] 云失败后可回退本地，不出现白屏或阻塞
- [ ] 错误日志包含 action 维度，便于定位

---

## 3. 性能与错误阈值（建议门槛）

- [ ] 商品列表首屏接口（云可用）P95 < 1500ms
- [ ] 任务大厅首屏接口（云可用）P95 < 1500ms
- [ ] 聊天详情增量拉取（20条）P95 < 1000ms
- [ ] 核心链路错误率（5xx/异常）< 1%
- [ ] 本地回退率（日常网络）< 5%

> 说明：若超过阈值，需附优化说明与风险评估，不建议直接提审。

---

## 4. 云函数输入校验

- [ ] `login` 已校验 event / userInfo 结构与字段长度
- [ ] `generateProductDesc` 已校验 category 类型/长度/白名单
- [ ] 非法参数返回明确错误码与 message
- [ ] 合法参数不影响现有业务返回结构

---

## 5. Token 生命周期策略（当前版）

## 5.1 发行（Issue）

- [ ] 仅在 `login` 云函数中签发 token
- [ ] token 不包含敏感明文字段
- [ ] token 生成使用随机因子（避免可预测）

## 5.2 存储（Store）

- [ ] 客户端仅使用本地存储（`cm_token`）
- [ ] 不在日志中打印 token 全值
- [ ] 退出登录时清理 token

## 5.3 使用（Use）

- [ ] 请求头带 `Authorization: Bearer <token>`（如有 HTTP 接口）
- [ ] 服务端接口不信任客户端身份字段，优先使用云上下文身份

## 5.4 轮换与失效（Rotate / Revoke）

- [ ] 客户端支持重新登录换发 token
- [ ] token 泄露场景可通过强制重新登录进行失效处置
- [ ] 后续演进计划：引入短期 token + 服务端校验黑白名单

---

## 6. 安全配置核查

- [ ] `urlCheck` 上线前已开启并验证（文本/图片内容发布入口）
- [ ] 数据库权限规则与集合权限已复核（最小权限）
- [ ] 越权操作（商品删除/状态变更、任务状态）已验证拒绝
- [ ] 敏感操作具备审计日志（至少 console 级可追踪）

---

## 7. 发布结论

- 提审版本：____
- 检查日期：____
- 检查人：____

- 结论：
  - [ ] 通过，进入提审
  - [ ] 阻塞，需修复后复核

- 阻塞项：
  - 模块 / 现象 / 负责人 / 预计修复时间
