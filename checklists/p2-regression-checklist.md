# P2 轻量回归检查清单（Product / Task / Chat）

> 目标：在「统一云调用包装 + 输入校验补强」后，快速确认关键链路无回归。

---

## 0. 执行准备

- [ ] 使用测试账号 A（卖家/发布者）与 B（买家/接单者）
- [ ] 微信开发者工具已连接云环境
- [ ] 编译通过：`npm run build:mp-weixin`
- [ ] 清理本地缓存（可选）：删除 `cm_*` 本地存储后重新进入

---

## 1. Product 链路

### 1.1 主链路

- [ ] 商品列表可加载（默认排序）
- [ ] 商品搜索/分类筛选结果正确
- [ ] 商品详情可打开，基础字段正常
- [ ] 发布商品成功（含图片与文本）
- [ ] “我的商品”分页正常
- [ ] 商品状态更新成功（在售 -> 下架/已售）
- [ ] 商品删除成功

### 1.2 异常与回退

- [ ] 云端异常时，列表可回退到本地数据
- [ ] 云端异常时，发布可回退本地并可在“我的商品”看到
- [ ] 非拥有者更新/删除商品被拒绝（无越权）
- [ ] 控制台存在可追踪日志：`[ProductService] ... cloud failed, fallback to local`

---

## 2. Task 链路

### 2.1 主链路

- [ ] 任务大厅列表加载正常
- [ ] 发布任务成功
- [ ] 接单成功，状态从 `open` -> `assigned`
- [ ] 状态流转合法（picked_up/delivered/completed/cancelled）
- [ ] 我的任务（发布/接单）列表准确
- [ ] 任务用户统计正常显示

### 2.2 异常与回退

- [ ] 云端异常时，任务列表回退本地成功
- [ ] 云端异常时，状态更新可在本地路径完成
- [ ] 非法状态跳转被拒绝
- [ ] 非授权用户操作任务状态被拒绝
- [ ] 控制台存在可追踪日志：`[TaskService] ... cloud failed, fallback to local`

---

## 3. Chat 链路

### 3.1 主链路

- [ ] 会话列表加载正常
- [ ] 会话详情加载消息正常
- [ ] 文本消息收发成功
- [ ] 图片消息发送成功
- [ ] 卡片消息发送成功（商品/任务）
- [ ] 已读状态更新正常

### 3.2 增量与异常

- [ ] 增量拉取参数生效（`afterCreatedAt` 有效）
- [ ] watch 断开后轮询兜底可工作
- [ ] 云端异常时，可回退本地消息
- [ ] 控制台存在可追踪日志：`[ChatService] ... cloud failed, fallback to local`

---

## 4. 云函数输入校验

- [ ] `login`：非对象 event 被拒绝（`code = -2`）
- [ ] `login`：异常 `userInfo` 结构被拒绝
- [ ] `generateProductDesc`：非字符串 `category` 被拒绝
- [ ] `generateProductDesc`：不在白名单的 `category` 被拒绝
- [ ] `generateProductDesc`：合法 category 返回 `success: true`

---

## 5. 回归结论

- 回归日期：____
- 执行人：____
- 结论：
  - [ ] 通过，可进入提审前检查
  - [ ] 不通过，需修复后复测

- 缺陷记录：
  - 缺陷ID/现象/复现步骤/责任模块/修复状态
